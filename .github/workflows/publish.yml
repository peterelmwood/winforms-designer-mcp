name: Publish

on:
    push:
        tags: ["v*"]

permissions:
    contents: write

jobs:
    publish-nuget:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Determine version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

            - name: Restore
              run: dotnet restore

            - name: Build
              run: dotnet build -c Release --no-restore -p:Version=${{ steps.version.outputs.VERSION }}

            - name: Pack
              run: dotnet pack -c Release --no-build -o ./artifacts -p:Version=${{ steps.version.outputs.VERSION }}

            - name: Push to NuGet.org
              run: dotnet nuget push ./artifacts/*.nupkg -s https://api.nuget.org/v3/index.json -k ${{ secrets.NUGET_API_KEY }} --skip-duplicate

    publish-binaries:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - rid: win-x64
                      artifact: winforms-designer-mcp-win-x64
                    - rid: linux-x64
                      artifact: winforms-designer-mcp-linux-x64
                    - rid: osx-arm64
                      artifact: winforms-designer-mcp-osx-arm64
        steps:
            - uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Determine version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

            - name: Publish self-contained
              run: >
                  dotnet publish src/winforms-designer-mcp/winforms-designer-mcp.csproj -c Release
                  -r ${{ matrix.rid }}
                  --self-contained
                  -p:PublishSingleFile=true
                  -p:Version=${{ steps.version.outputs.VERSION }}
                  -o ./publish

            - name: Archive
              run: tar -czf ${{ matrix.artifact }}.tar.gz -C ./publish .

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.tar.gz

    create-release:
        needs: [publish-nuget, publish-binaries]
        runs-on: ubuntu-latest
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./release-assets
                  merge-multiple: true

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: ./release-assets/*.tar.gz
